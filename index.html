<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Third Eye Computer Class Student Resume Maker</title>

  <!-- Tailwind and html2pdf -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --accent: #6366f1; --accent-600: #4f46e5; --bg-grad-from: #eef2ff; --bg-grad-to: #e0e7ff; }
    html,body { height:100%; }
    body {
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, var(--bg-grad-from), var(--bg-grad-to));
      margin: 0;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .resume-card {
      background: #fff;
      border-radius: 1rem;
      padding: 1.75rem;
      box-shadow: 0 12px 30px rgba(16,24,40,0.08);
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent-600);
      border-bottom: 2px solid #c7d2fe;
      padding-bottom: 0.25rem;
      margin-bottom: 0.5rem;
    }

    /* Ensure printed/pdf colors & layout are consistent */
    @media print {
      body { background: white; }
      .resume-card { box-shadow: none; margin: 0; padding: 1rem; border-radius: 0; }
    }

    /* small button style convenience */
    .btn { transition: transform .06s ease; }
    .btn:active { transform: translateY(1px); }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">

  <header class="text-center mb-6">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-700 mb-1">Third Eye Computer Class Student Resume Maker</h1>
    <p class="text-gray-600 text-sm">Contact: <span class="font-semibold text-gray-800">8078618395</span></p>
  </header>

  <main class="w-full max-w-7xl flex flex-col lg:flex-row gap-8">
    <!-- Left: Form -->
    <aside class="lg:w-1/3 bg-white p-6 rounded-2xl shadow-lg">
      <h2 class="text-xl font-bold text-indigo-700 text-center mb-4">üéì Enter Details</h2>

      <form id="resume-form" class="space-y-3" onsubmit="return false;">
        <input id="name" placeholder="Full name" class="w-full p-3 border border-indigo-100 rounded-lg" />
        <input id="email" placeholder="Email address" class="w-full p-3 border border-indigo-100 rounded-lg" />
        <input id="phone" placeholder="Phone number" class="w-full p-3 border border-indigo-100 rounded-lg" />
        <textarea id="summary" rows="3" placeholder="Profile summary" class="w-full p-3 border border-indigo-100 rounded-lg"></textarea>
        <textarea id="experience" rows="3" placeholder="Experience ‚Äî one item per line" class="w-full p-3 border border-indigo-100 rounded-lg"></textarea>
        <textarea id="education" rows="2" placeholder="Education details" class="w-full p-3 border border-indigo-100 rounded-lg"></textarea>
        <input id="skills" placeholder="Skills (comma-separated)" class="w-full p-3 border border-indigo-100 rounded-lg" />
      </form>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <button id="download-pdf" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg btn">üìÑ PDF</button>
        <button id="download-html" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg btn">üåê HTML</button>
        <button id="send-boss" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg btn">üí¨ Send</button>
      </div>
    </aside>

    <!-- Right: Preview -->
    <section class="lg:w-2/3">
      <div id="resume-output" class="resume-card text-gray-800">
        <header class="text-center">
          <h1 id="out-name" class="text-2xl sm:text-3xl font-bold text-indigo-700">Your Name</h1>
          <p id="out-contact" class="text-gray-600 mt-1">Email | Phone</p>
        </header>

        <div class="mt-4">
          <h3 class="section-title">Summary</h3>
          <div id="out-summary" class="text-gray-700">Your profile summary will appear here.</div>
        </div>

        <div class="mt-4">
          <h3 class="section-title">Experience</h3>
          <ul id="out-experience" class="list-disc pl-5 text-gray-700"></ul>
        </div>

        <div class="mt-4">
          <h3 class="section-title">Education</h3>
          <div id="out-education" class="text-gray-700">Education details...</div>
        </div>

        <div class="mt-4">
          <h3 class="section-title">Skills</h3>
          <ul id="out-skills" class="list-disc pl-5 grid grid-cols-2 gap-1 text-gray-700"></ul>
        </div>
      </div>
    </section>
  </main>

  <footer class="mt-8 text-gray-500 text-sm">¬© 2025 Third Eye Computer Class</footer>

  <script>
    /* -------------------------
       Lightweight safe helpers
    ------------------------- */
    const el = id => document.getElementById(id);

    function safeText(s) { return (s === null || s === undefined) ? '' : String(s); }
    function sanitizeText(s) { return safeText(s).trim(); }

    // escape to avoid accidental HTML injection
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
      });
    }

    /* -------------------------
       Update resume preview
    ------------------------- */
    function updateResume() {
      // if any element missing, bail safely
      const nameEl = el('name'), emailEl = el('email'), phoneEl = el('phone'),
            summaryEl = el('summary'), experienceEl = el('experience'),
            educationEl = el('education'), skillsEl = el('skills');

      const outName = el('out-name'), outContact = el('out-contact'),
            outSummary = el('out-summary'), outExperience = el('out-experience'),
            outEducation = el('out-education'), outSkills = el('out-skills');

      if (!outName) return;

      const name = sanitizeText(nameEl?.value) || 'Your Name';
      const email = sanitizeText(emailEl?.value);
      const phone = sanitizeText(phoneEl?.value);
      const summary = sanitizeText(summaryEl?.value) || 'Your profile summary will appear here.';
      const experience = (sanitizeText(experienceEl?.value) || '').split('\n').map(x => x.trim()).filter(Boolean);
      const education = sanitizeText(educationEl?.value) || 'Education details...';
      const skills = (sanitizeText(skillsEl?.value) || '').split(',').map(x => x.trim()).filter(Boolean);

      outName.textContent = name;
      outContact.textContent = [email, phone].filter(Boolean).join(' | ');
      outSummary.textContent = summary;
      outExperience.innerHTML = experience.map(i => `<li>${escapeHtml(i)}</li>`).join('');
      outEducation.textContent = education;
      outSkills.innerHTML = skills.map(s => `<li>${escapeHtml(s)}</li>`).join('');
    }

    // wire inputs to live preview
    const formInputs = ['name','email','phone','summary','experience','education','skills'];
    formInputs.forEach(id => {
      const node = el(id);
      if (node) node.addEventListener('input', updateResume);
    });

    // initial populate
    window.addEventListener('DOMContentLoaded', () => {
      updateResume();
    });

    /* -------------------------
       PDF generation helpers
       - ensures fonts rendered before capture
    ------------------------- */
    async function readyToRenderForPdf() {
      try {
        if (document.fonts && document.fonts.ready) {
          await document.fonts.ready;
        }
      } catch (e) {
        // ignore
      }
      // small delay so browser renders
      await new Promise(r => setTimeout(r, 150));
    }

    // returns a Blob of rendered PDF
    async function generatePdfBlob(filename = 'resume.pdf') {
      await readyToRenderForPdf();
      const resumeEl = el('resume-output');
      if (!resumeEl) throw new Error('Resume element not found');

      const opt = {
        margin: 0.4,
        filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, allowTaint: false, logging: false },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
      };

      // html2pdf().from(...).toPdf().get('pdf') returns jsPDF instance.
      // We create the pdf and return a Blob by using .output('blob')
      return new Promise((resolve, reject) => {
        try {
          html2pdf().set(opt).from(resumeEl).toPdf().output('blob').then(blob => {
            resolve(blob);
          }).catch(err => reject(err));
        } catch (err) {
          reject(err);
        }
      });
    }

    /* -------------------------
       Buttons: download PDF / HTML
    ------------------------- */
    const btnPdf = el('download-pdf');
    const btnHtml = el('download-html');
    const btnSend = el('send-boss');

    if (btnPdf) {
      btnPdf.addEventListener('click', async () => {
        try {
          btnPdf.disabled = true;
          updateResume();
          await readyToRenderForPdf();
          const resumeEl = el('resume-output');
          html2pdf().set({
            margin: 0.4,
            filename: 'resume.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'a4' }
          }).from(resumeEl).save();
        } catch (err) {
          alert('PDF generation failed: ' + (err.message || err));
          console.error(err);
        } finally {
          btnPdf.disabled = false;
        }
      });
    }

    if (btnHtml) {
      btnHtml.addEventListener('click', () => {
        try {
          updateResume();
          const safeName = (el('out-name')?.textContent || 'resume').replace(/\s+/g,'_').toLowerCase();
          const docHead = `
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Resume - ${escapeHtml(el('out-name')?.textContent || '')}</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background: #f8fafc; padding: 24px; }
  .resume-card { background:#fff; border-radius:12px; padding:20px; max-width:800px; margin:0 auto; }
  .section-title { font-weight:700; color:#4f46e5; border-bottom:2px solid #e6e9ff; padding-bottom:6px; margin-bottom:8px; }
</style>
</head>
<body>
<div class="resume-card">
`;

          const docFooter = `</div></body></html>`;

          // Use sanitized innerHTML of preview card
          const contentHtml = el('resume-output')?.innerHTML || '';
          const fullHtml = docHead + contentHtml + docFooter;
          const blob = new Blob([fullHtml], { type: 'text/html' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${safeName}.html`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          // revoke after a short delay to ensure download started
          setTimeout(() => URL.revokeObjectURL(a.href), 1500);
        } catch (err) {
          alert('HTML download failed: ' + (err.message || err));
          console.error(err);
        }
      });
    }

    /* --------------------------------------------------------
       Upload to GoFile (CORS-friendly) & Send WhatsApp link
       - uploadToGofile returns the public download page URL string
       - NOTE: public endpoints may change; keep that in mind
       -------------------------------------------------------- */
    async function uploadToGofile(blob, filename = 'resume.pdf') {
      const fd = new FormData();
      // The server expects a 'file' field
      fd.append('file', blob, filename);

      // store1.gofile.io is a commonly used mirror; if it fails the endpoint may have changed
      const endpoint = 'https://store1.gofile.io/uploadFile';
      const response = await fetch(endpoint, {
        method: 'POST',
        body: fd
      });

      if (!response.ok) {
        throw new Error('Upload response not OK: ' + response.status);
      }

      // Defensive parse
      let data;
      try {
        data = await response.json();
      } catch (e) {
        throw new Error('Failed to parse upload response: ' + e.message);
      }

      // expected structure: { data: { downloadPage: 'https://...' } }
      if (data && data.data && data.data.downloadPage) return data.data.downloadPage;
      // sometimes gofile returns a direct link in data.code or data.downloadPage - check alternatives
      if (data && data.downloadPage) return data.downloadPage;
      if (data && data.data && data.data.link) return data.data.link;

      throw new Error('Upload failed: invalid response structure');
    }

    if (btnSend) {
      btnSend.addEventListener('click', async () => {
        try {
          btnSend.disabled = true;
          updateResume();
          // generate PDF blob
          const studentName = sanitizeText(el('out-name')?.textContent) || 'student';
          const filename = `${studentName.replace(/\s+/g,'_') || 'resume'}.pdf`;
          const blob = await generatePdfBlob(filename);

          // upload
          const uploadingMsg = 'Uploading resume. This may take a few seconds...';
          console.log(uploadingMsg);
          // show simple UI feedback
          alert('Uploading resume to file host. Please allow the popup for WhatsApp when it appears.');

          const link = await uploadToGofile(blob, filename);

          // Compose WhatsApp message
          // Replace boss number below if needed (format: countrycode + number, no +'s or dashes)
          const bossNumber = '9180788618395'; // <<-- change to actual boss number if required
          const name = encodeURIComponent(el('out-name')?.textContent || 'Unnamed Student');
          const skillsRaw = sanitizeText(el('skills')?.value || '');
          const skills = encodeURIComponent(skillsRaw || 'Not specified');
          const encodedLink = encodeURIComponent(link);
          const msg = `Hello Sir üëã%0A%0ANew student resume:%0AName: ${name}%0ASkills: ${skills}%0AResume: ${encodedLink}%0A%0A‚Äì Third Eye Computer Class`;

          // open WhatsApp chat in new tab
          const waUrl = `https://wa.me/${bossNumber}?text=${msg}`;
          window.open(waUrl, '_blank');

          // small confirmation
          setTimeout(() => alert('Resume uploaded and WhatsApp opened.'), 700);
        } catch (err) {
          alert('Send failed: ' + (err.message || err));
          console.error(err);
        } finally {
          btnSend.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
